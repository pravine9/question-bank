<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Practice Test</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap">
  <link rel="stylesheet" href="{{ url_for('static', filename='practice.css') }}">
</head>
<body>
  <header class="header">
    <span class="test-title">Test: 2025 example questions Part 1</span>
    <div class="progress"><div class="bar" style="width:0%"></div></div>
    <div class="header-right">
      <button class="finish-btn">Finish Test</button>
      <span class="candidate">Candidate Name</span>
    </div>
  </header>

  <div class="main">
    <aside class="sidebar">
      <ul class="nav"></ul>
    </aside>

    <section class="question-area">
      <h2 class="q-number"></h2>
      <p class="scenario"></p>
      <div class="options"></div>
      <div class="calculator" style="display:none">
        <span class="icon">&#128425;</span>
        <label>Answer</label>
        <input type="number">
        <span class="unit"></span>
      </div>
      <button class="check-btn">Check</button>
      <div class="feedback"></div>
      <div class="details" style="display:none">
        <div class="correct-answer"></div>
        <div class="explanation"></div>
      </div>
    </section>
  </div>

  <section class="summary" style="display:none">
    <h2>Test Summary</h2>
    <table class="summary-table">
      <thead>
        <tr><th>#</th><th>Your Answer</th><th>Correct Answer</th><th>Review</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <footer class="footer">
    <span class="settings">&#9881;</span>
    <button class="close-btn">Close all open tools</button>
    <div class="nav-btns">
      <button class="back-btn">Back</button>
      <button class="next-btn">Next ‚ùØ</button>
    </div>
  </footer>

  <script>
    const questions = {{ questions|tojson|safe }};
    let index = 0;
    let selected = null;
    const responses = Array(questions.length).fill(null);
    let reviewing = false;

    function initNav() {
      const nav = document.querySelector('.nav');
      nav.textContent = '';
      const data = JSON.parse(localStorage.getItem('questionStats') || '{}');
      questions.forEach((q,i) => {
        const li = document.createElement('li');
        li.innerHTML = `${i+1}<button class="flag-btn" title="Flag">\u2691</button>`;
        if(i===0) li.classList.add('active');
        if (data[q.id] && data[q.id].saved) li.classList.add('flagged');
        const flag = li.querySelector('.flag-btn');
        flag.onclick = (e) => {
          e.stopPropagation();
          toggleFlag(q.id, li);
        };
        li.onclick = () => { index = i; renderQuestion(); };
        nav.appendChild(li);
      });
    }

    function toggleFlag(id, li) {
      const data = JSON.parse(localStorage.getItem('questionStats') || '{}');
      if (!data[id]) data[id] = {right:0, wrong:0, saved:false};
      data[id].saved = !data[id].saved;
      localStorage.setItem('questionStats', JSON.stringify(data));
      li.classList.toggle('flagged', data[id].saved);
    }

    function updateProgress() {
      const pct = ((index + 1) / questions.length) * 100;
      document.querySelector('.bar').style.width = pct + '%';
    }

    function updateNav() {
      const data = JSON.parse(localStorage.getItem('questionStats') || '{}');
      document.querySelectorAll('.nav li').forEach((li,i) => {
        const q = questions[i];
        li.classList.toggle('active', i === index);
        const flagged = data[q.id] && data[q.id].saved;
        li.classList.toggle('flagged', flagged);
      });
    }

    function renderQuestion() {
      const q = questions[index];
      selected = null;
      document.querySelector('.q-number').textContent = `Question ${index + 1}`;
      document.querySelector('.scenario').textContent = q.text || q.title || '';
      const opts = document.querySelector('.options');
      const calc = document.querySelector('.calculator');
      const input = calc.querySelector('input');
      const unit = calc.querySelector('.unit');
      const feedback = document.querySelector('.feedback');
      const details = document.querySelector('.details');
      const corr = details.querySelector('.correct-answer');
      const expl = details.querySelector('.explanation');
      feedback.textContent = '';
      feedback.className = 'feedback';
      details.style.display = 'none';
      corr.textContent = '';
      expl.textContent = '';
      opts.textContent = '';
      if(q.answers && q.answers.length){
        calc.style.display = 'none';
        q.answers.forEach(a => {
          const btn = document.createElement('button');
          btn.textContent = a.text;
          btn.dataset.num = a.answer_number;
          btn.onclick = () => {
            if(reviewing) return;
            opts.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selected = a.answer_number;
          };
          if(responses[index] && responses[index].answer == a.answer_number){
            btn.classList.add('selected');
            selected = a.answer_number;
          }
          if(reviewing) btn.disabled = true;
          opts.appendChild(btn);
        });
      } else {
        calc.style.display = 'block';
        input.value = responses[index] ? (responses[index].answer || '') : '';
        unit.textContent = q.answer_unit || '';
        input.disabled = reviewing;
      }
      if(reviewing && responses[index]){
        const fb = document.querySelector('.feedback');
        fb.textContent = responses[index].correct ? 'Correct!' : 'Incorrect';
        fb.className = 'feedback ' + (responses[index].correct ? 'correct' : 'incorrect');
        corr.textContent = responses[index].correctAnswer ? `Correct answer: ${responses[index].correctAnswer}` : '';
        let expText = questions[index].why || '';
        expText = expText.replace(/\u2028/g, '\n').replace(/\u00a0/g, ' ').replace(/\u200b/g, '');
        if (typeof DOMPurify !== 'undefined' && typeof marked !== 'undefined') {
          expl.innerHTML = DOMPurify.sanitize(marked.parse(expText));
        } else {
          expl.textContent = expText;
        }
        details.style.display = 'block';
      } else {
        const fb = document.querySelector('.feedback');
        fb.textContent = '';
        fb.className = 'feedback';
        details.style.display = 'none';
      }
      updateProgress();
      updateNav();
    }

    function updateStats(id, correct) {
      const data = JSON.parse(localStorage.getItem('questionStats') || '{}');
      if (!data[id]) data[id] = {right:0, wrong:0, saved:false};
      if (correct) data[id].right++; else data[id].wrong++;
      localStorage.setItem('questionStats', JSON.stringify(data));
    }

    function recordAnswer(){
      const q = questions[index];
      const calc = document.querySelector('.calculator');
      const input = calc.querySelector('input');
      let userAns = null;
      let userText = '';
      if(q.answers && q.answers.length){
        userAns = selected;
        const obj = q.answers.find(a => a.answer_number == selected);
        userText = obj ? obj.text : '';
      } else {
        userAns = input.value.trim();
        userText = userAns ? userAns + (q.answer_unit ? ` ${q.answer_unit}` : '') : '';
      }
      let correctText = '';
      if(q.answers && q.answers.length){
        const obj = q.answers.find(a => a.answer_number == q.correct_answer_number);
        correctText = obj ? obj.text : '';
      } else {
        correctText = (q.correct_answer || '') + (q.answer_unit ? ` ${q.answer_unit}` : '');
      }
      const correct = q.answers && q.answers.length ? (selected == q.correct_answer_number) : (userAns === (q.correct_answer || ''));
      responses[index] = {answer: userAns, text: userText, correctAnswer: correctText, correct};
    }

    document.querySelector('.next-btn').onclick = () => {
      recordAnswer();
      if(index < questions.length - 1){ index++; renderQuestion(); }
    };
    document.querySelector('.back-btn').onclick = () => {
      recordAnswer();
      if(index > 0){ index--; renderQuestion(); }
    };

    document.querySelector('.check-btn').onclick = () => {
      const q = questions[index];
      const calc = document.querySelector('.calculator');
      const input = calc.querySelector('input');
      let correct = false;
      if(q.answers && q.answers.length){
        correct = selected == q.correct_answer_number;
      } else {
        const value = input.value.trim();
        correct = value === (q.correct_answer || '');
      }
      const fb = document.querySelector('.feedback');
      fb.textContent = correct ? 'Correct!' : 'Incorrect';
      fb.className = 'feedback ' + (correct ? 'correct' : 'incorrect');
      updateStats(q.id, correct);
      recordAnswer();
    };

    document.addEventListener('DOMContentLoaded', () => {
      if(!questions.length) return;
      initNav();
      renderQuestion();
    });

    function showSummary(){
      recordAnswer();
      reviewing = false;
      document.querySelector('.main').style.display = 'none';
      document.querySelector('.footer').style.display = 'none';
      const summary = document.querySelector('.summary');
      const tbody = summary.querySelector('tbody');
      tbody.textContent = '';
      responses.forEach((r,i) => {
        const tr = document.createElement('tr');
        const ua = r ? r.text || '' : '';
        const ca = r ? r.correctAnswer || '' : '';
        tr.innerHTML = `<td>${i+1}</td><td>${ua}</td><td>${ca}</td><td><button data-idx='${i}'>Review</button></td>`;
        tbody.appendChild(tr);
      });
      summary.style.display = 'block';
      summary.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.onclick = () => {
          index = parseInt(btn.getAttribute('data-idx'), 10);
          reviewing = true;
          summary.style.display = 'none';
          document.querySelector('.main').style.display = 'flex';
          document.querySelector('.footer').style.display = 'flex';
          renderQuestion();
        };
      });
    }

    document.querySelector('.finish-btn').onclick = () => {
      if (confirm('Are you sure you want to finish the test?')) {
        showSummary();
      }
    };
  </script>
</body>
</html>
